/**
 * install_mismo_import.cjs
 * LoanBeacons - MISMO Import Feature Installer (fixed)
 */

const fs = require('fs');
const path = require('path');

const SCENARIO_CREATOR = path.join('src', 'pages', 'ScenarioCreator.jsx');
const PARSE_URLA_DEST  = path.join('src', 'utils', 'parseURLA.js');

if (!fs.existsSync(SCENARIO_CREATOR)) {
  console.error('ERROR: Cannot find src/pages/ScenarioCreator.jsx');
  console.error('Make sure you are running this from your loanbeacons-app folder.');
  process.exit(1);
}

// ── Write parseURLA.js ────────────────────────────────────────────────────────
var parseURLA_content = '/**\n * parseURLA.js\n * LoanBeacons - MISMO 3.4 URLA XML Parser (browser-compatible)\n */\n\nfunction getTag(node, tagName) {\n  var el = node.getElementsByTagName(tagName)[0];\n  return el ? (el.textContent || \'\').trim() : \'\';\n}\n\nfunction parseDollar(val) {\n  var n = parseFloat(val);\n  return (!isNaN(n) && n > 0) ? String(Math.round(n)) : \'\';\n}\n\nfunction parseRate(val) {\n  var n = parseFloat(val);\n  return (!isNaN(n) && n > 0) ? String(n) : \'\';\n}\n\nfunction mapOccupancy(mismo) {\n  var map = { PrimaryResidence: \'Primary Residence\', SecondHome: \'Second Home\', Investor: \'Investment Property\', Investment: \'Investment Property\' };\n  return map[mismo] || mismo || \'\';\n}\n\nfunction mapLoanPurpose(mismo) {\n  var map = { Purchase: \'PURCHASE\', Refinance: \'REFINANCE\', NoCashOutRefinance: \'REFINANCE\', CashOutRefinance: \'CASH_OUT\', StreamlineRefinance: \'STREAMLINE\' };\n  return map[mismo] || \'\';\n}\n\nfunction mapLoanType(mismo) {\n  var map = { Conventional: \'CONVENTIONAL\', FHA: \'FHA\', VA: \'VA\', USDA: \'USDA\', Jumbo: \'JUMBO\' };\n  return map[mismo] || mismo || \'\';\n}\n\nfunction mapPropertyType(attachment, construction, units, isPUD) {\n  if (units >= 2 && units <= 4) return \'Multi-Family (2-4 units)\';\n  if (isPUD) return \'Single Family\';\n  if (construction === \'Manufactured\') return \'Single Family\';\n  if (attachment === \'Attached\' || attachment === \'SemiDetached\') return \'Townhouse\';\n  return \'Single Family\';\n}\n\nfunction formatPhone(raw) {\n  if (!raw) return \'\';\n  var d = raw.replace(/\\D/g, \'\');\n  return d.length === 10 ? \'(\' + d.slice(0,3) + \') \' + d.slice(3,6) + \'-\' + d.slice(6) : raw;\n}\n\nexport function parseURLA(xmlString) {\n  var parser = new DOMParser();\n  var doc = parser.parseFromString(xmlString, \'application/xml\');\n  if (doc.getElementsByTagName(\'parsererror\').length > 0) {\n    throw new Error(\'Invalid XML file. Please upload a valid MISMO 3.4 URLA export.\');\n  }\n\n  var result = {\n    _importMeta: { losName: \'\', fileCreated: \'\', loanNumber: \'\' },\n    firstName: \'\', lastName: \'\', borrowerPhone: \'\', borrowerEmail: \'\',\n    ssnPresent: false, maritalStatus: \'\', dependentCount: \'\',\n    employerName: \'\', employmentTitle: \'\', selfEmployed: false,\n    monthlyIncome: \'\', monthlyDebts: \'\',\n    streetAddress: \'\', city: \'\', county: \'\', state: \'\', zipCode: \'\',\n    fipsState: \'\', fipsCounty: \'\',\n    propertyType: \'Single Family\', occupancy: \'\',\n    purchasePrice: \'\', propertyValue: \'\',\n    loanAmount: \'\', loanPurpose: \'\', loanType: \'\',\n    interestRate: \'\', term: \'360\',\n    proposedPI: \'\', proposedTaxes: \'\', proposedInsurance: \'\',\n    proposedMIP: \'\', cashToClose: \'\',\n    ufmipFinanced: \'\', ufmipTotal: \'\', estimatedClosingCosts: \'\',\n    liabilities: [], assets: [], totalAssets: \'\',\n    loFirstName: \'\', loLastName: \'\', loNMLS: \'\', companyName: \'\',\n  };\n\n  var origSystem = doc.getElementsByTagName(\'ORIGINATION_SYSTEM\')[0];\n  if (origSystem) result._importMeta.losName = getTag(origSystem, \'LoanOriginationSystemName\');\n  var aboutVersion = doc.getElementsByTagName(\'ABOUT_VERSION\')[0];\n  if (aboutVersion) result._importMeta.fileCreated = getTag(aboutVersion, \'CreatedDatetime\').split(\'T\')[0];\n  var loanIdEl = doc.getElementsByTagName(\'LOAN_IDENTIFIER\')[0];\n  if (loanIdEl) result._importMeta.loanNumber = getTag(loanIdEl, \'LoanIdentifier\');\n\n  var subjectProp = doc.getElementsByTagName(\'SUBJECT_PROPERTY\')[0];\n  if (subjectProp) {\n    var addr = subjectProp.getElementsByTagName(\'ADDRESS\')[0];\n    if (addr) {\n      result.streetAddress = getTag(addr, \'AddressLineText\');\n      result.city = getTag(addr, \'CityName\');\n      result.county = getTag(addr, \'CountyName\');\n      result.state = getTag(addr, \'StateCode\');\n      result.zipCode = getTag(addr, \'PostalCode\');\n    }\n    var fips = subjectProp.getElementsByTagName(\'FIPS_INFORMATION\')[0];\n    if (fips) { result.fipsState = getTag(fips, \'FIPSStateNumericCode\'); result.fipsCounty = getTag(fips, \'FIPSCountyCode\'); }\n    var propDetail = subjectProp.getElementsByTagName(\'PROPERTY_DETAIL\')[0];\n    if (propDetail) {\n      result.occupancy = mapOccupancy(getTag(propDetail, \'PropertyUsageType\'));\n      var units = parseInt(getTag(propDetail, \'FinancedUnitCount\')) || 1;\n      var attachment = getTag(propDetail, \'AttachmentType\');\n      var conMethod = getTag(propDetail, \'ConstructionMethodType\');\n      var isPUD = getTag(propDetail, \'PUDIndicator\') === \'true\';\n      result.propertyType = mapPropertyType(attachment, conMethod, units, isPUD);\n      result.propertyValue = parseDollar(getTag(propDetail, \'PropertyEstimatedValueAmount\'));\n    }\n    var salesContract = subjectProp.getElementsByTagName(\'SALES_CONTRACT_DETAIL\')[0];\n    if (salesContract) result.purchasePrice = parseDollar(getTag(salesContract, \'SalesContractAmount\'));\n    if (!result.purchasePrice && result.propertyValue) result.purchasePrice = result.propertyValue;\n  }\n\n  var termsOfLoan = doc.getElementsByTagName(\'TERMS_OF_LOAN\')[0];\n  if (termsOfLoan) {\n    result.loanAmount = parseDollar(getTag(termsOfLoan, \'BaseLoanAmount\'));\n    result.loanPurpose = mapLoanPurpose(getTag(termsOfLoan, \'LoanPurposeType\'));\n    result.loanType = mapLoanType(getTag(termsOfLoan, \'MortgageType\'));\n    result.interestRate = parseRate(getTag(termsOfLoan, \'NoteRatePercent\'));\n  }\n\n  var amortRule = doc.getElementsByTagName(\'AMORTIZATION_RULE\')[0];\n  if (amortRule) {\n    var count = getTag(amortRule, \'LoanAmortizationPeriodCount\');\n    var ptype = getTag(amortRule, \'LoanAmortizationPeriodType\');\n    if (count && ptype === \'Month\') result.term = count;\n    else if (count && ptype === \'Year\') result.term = String(parseInt(count) * 12);\n  }\n\n  var urlaDetail = doc.getElementsByTagName(\'URLA_DETAIL\')[0];\n  if (urlaDetail) {\n    result.ufmipFinanced = parseDollar(getTag(urlaDetail, \'MIAndFundingFeeFinancedAmount\'));\n    result.ufmipTotal = parseDollar(getTag(urlaDetail, \'MIAndFundingFeeTotalAmount\'));\n    result.estimatedClosingCosts = parseDollar(getTag(urlaDetail, \'EstimatedClosingCostsAmount\'));\n  }\n\n  var closingDetail = doc.getElementsByTagName(\'CLOSING_INFORMATION_DETAIL\')[0];\n  if (closingDetail) result.cashToClose = parseDollar(getTag(closingDetail, \'CashFromBorrowerAtClosingAmount\'));\n\n  Array.from(doc.getElementsByTagName(\'HOUSING_EXPENSE\')).forEach(function(exp) {\n    if (getTag(exp, \'HousingExpenseTimingType\') !== \'Proposed\') return;\n    var amt = getTag(exp, \'HousingExpensePaymentAmount\');\n    var htype = getTag(exp, \'HousingExpenseType\');\n    if (htype === \'FirstMortgagePrincipalAndInterest\') result.proposedPI = amt;\n    else if (htype === \'RealEstateTax\') result.proposedTaxes = amt;\n    else if (htype === \'HomeownersInsurance\') result.proposedInsurance = amt;\n    else if (htype === \'MIPremium\') result.proposedMIP = amt;\n  });\n\n  Array.from(doc.getElementsByTagName(\'PARTY\')).forEach(function(party) {\n    Array.from(party.getElementsByTagName(\'ROLE\')).forEach(function(role) {\n      var roleType = getTag(role, \'PartyRoleType\');\n      if (roleType === \'Borrower\') {\n        var ind = party.getElementsByTagName(\'INDIVIDUAL\')[0];\n        if (ind) {\n          var nameEl = ind.getElementsByTagName(\'n\')[0];\n          if (nameEl) { result.firstName = getTag(nameEl, \'FirstName\'); result.lastName = getTag(nameEl, \'LastName\'); }\n          Array.from(ind.getElementsByTagName(\'CONTACT_POINT\')).forEach(function(cp) {\n            var tel = cp.getElementsByTagName(\'CONTACT_POINT_TELEPHONE\')[0];\n            var email = cp.getElementsByTagName(\'CONTACT_POINT_EMAIL\')[0];\n            if (tel) result.borrowerPhone = formatPhone(getTag(tel, \'ContactPointTelephoneValue\'));\n            if (email) result.borrowerEmail = getTag(email, \'ContactPointEmailValue\');\n          });\n        }\n        var bd = role.getElementsByTagName(\'BORROWER_DETAIL\')[0];\n        if (bd) { result.maritalStatus = getTag(bd, \'MaritalStatusType\'); result.dependentCount = getTag(bd, \'DependentCount\'); }\n        var totalIncome = 0;\n        Array.from(role.getElementsByTagName(\'CURRENT_INCOME_ITEM\')).forEach(function(item) {\n          totalIncome += parseFloat(getTag(item, \'CurrentIncomeMonthlyTotalAmount\')) || 0;\n        });\n        if (totalIncome > 0) result.monthlyIncome = String(totalIncome.toFixed(2));\n        var employer = role.getElementsByTagName(\'EMPLOYER\')[0];\n        if (employer) {\n          var leName = employer.getElementsByTagName(\'LEGAL_ENTITY_DETAIL\')[0];\n          if (leName) result.employerName = getTag(leName, \'FullName\');\n          var empDetail = employer.getElementsByTagName(\'EMPLOYMENT\')[0];\n          if (empDetail) {\n            result.selfEmployed = getTag(empDetail, \'EmploymentBorrowerSelfEmployedIndicator\') === \'true\';\n            result.employmentTitle = getTag(empDetail, \'EmploymentPositionDescription\');\n          }\n        }\n        Array.from(party.getElementsByTagName(\'TAXPAYER_IDENTIFIER\')).forEach(function(ti) {\n          if (getTag(ti, \'TaxpayerIdentifierType\') === \'SocialSecurityNumber\') {\n            var ssn = getTag(ti, \'TaxpayerIdentifierValue\');\n            result.ssnPresent = !!(ssn && ssn.replace(/\\D/g, \'\').length >= 9);\n          }\n        });\n      }\n      if (roleType === \'LoanOriginator\') {\n        var ind2 = party.getElementsByTagName(\'INDIVIDUAL\')[0];\n        if (ind2) {\n          var nameEl2 = ind2.getElementsByTagName(\'n\')[0];\n          if (nameEl2) { result.loFirstName = getTag(nameEl2, \'FirstName\'); result.loLastName = getTag(nameEl2, \'LastName\'); }\n        }\n        Array.from(role.getElementsByTagName(\'LICENSE\')).forEach(function(lic) {\n          if (getTag(lic, \'LicenseAuthorityLevelType\') === \'Private\') result.loNMLS = getTag(lic, \'LicenseIdentifier\');\n        });\n      }\n      if (roleType === \'LoanOriginationCompany\') {\n        var le = party.getElementsByTagName(\'LEGAL_ENTITY_DETAIL\')[0];\n        if (le) result.companyName = getTag(le, \'FullName\');\n      }\n    });\n  });\n\n  var totalDebts = 0;\n  Array.from(doc.getElementsByTagName(\'LIABILITY\')).forEach(function(liab) {\n    var detail = liab.getElementsByTagName(\'LIABILITY_DETAIL\')[0];\n    if (!detail) return;\n    var holderEl = liab.getElementsByTagName(\'LIABILITY_HOLDER\')[0];\n    var nEl = holderEl ? holderEl.getElementsByTagName(\'n\')[0] : null;\n    var holderName = nEl ? getTag(nEl, \'FullName\') : (holderEl ? getTag(holderEl, \'FullName\') : \'\');\n    var pmt = parseFloat(getTag(detail, \'LiabilityMonthlyPaymentAmount\')) || 0;\n    var bal = parseFloat(getTag(detail, \'LiabilityUnpaidBalanceAmount\')) || 0;\n    var excluded = getTag(detail, \'LiabilityExclusionIndicator\') === \'true\';\n    var payoff = getTag(detail, \'LiabilityPayoffStatusIndicator\') === \'true\';\n    result.liabilities.push({ creditor: holderName, type: getTag(detail, \'LiabilityType\'), balance: Math.round(bal), monthlyPayment: pmt, remainingMonths: parseInt(getTag(detail, \'LiabilityRemainingTermMonthsCount\')) || null, excluded: excluded, payoff: payoff });\n    if (!excluded && !payoff) totalDebts += pmt;\n  });\n  if (totalDebts > 0) result.monthlyDebts = String(totalDebts.toFixed(2));\n\n  var totalAssets = 0;\n  Array.from(doc.getElementsByTagName(\'ASSET\')).forEach(function(asset) {\n    var detail = asset.getElementsByTagName(\'ASSET_DETAIL\')[0];\n    if (!detail) return;\n    if (asset.getElementsByTagName(\'OWNED_PROPERTY\').length > 0) return;\n    var holderEl = asset.getElementsByTagName(\'ASSET_HOLDER\')[0];\n    var nEl = holderEl ? holderEl.getElementsByTagName(\'n\')[0] : null;\n    var holderName = nEl ? getTag(nEl, \'FullName\') : (holderEl ? getTag(holderEl, \'FullName\') : \'\');\n    var value = parseFloat(getTag(detail, \'AssetCashOrMarketValueAmount\')) || 0;\n    totalAssets += value;\n    result.assets.push({ institution: holderName, type: getTag(detail, \'AssetType\'), value: Math.round(value) });\n  });\n  if (totalAssets > 0) result.totalAssets = String(Math.round(totalAssets));\n\n  return result;\n}\n\nexport function getImportSummary(parsed) {\n  var fields = [];\n  if (parsed.firstName || parsed.lastName) fields.push(\'Borrower name\');\n  if (parsed.employerName) fields.push(\'Employer\');\n  if (parsed.monthlyIncome) fields.push(\'Monthly income\');\n  if (parsed.loanAmount) fields.push(\'Loan amount\');\n  if (parsed.purchasePrice) fields.push(\'Purchase price\');\n  if (parsed.interestRate) fields.push(\'Interest rate\');\n  if (parsed.term) fields.push(\'Loan term\');\n  if (parsed.loanType) fields.push(\'Loan type\');\n  if (parsed.loanPurpose) fields.push(\'Loan purpose\');\n  if (parsed.streetAddress) fields.push(\'Property address\');\n  if (parsed.monthlyDebts) fields.push(\'Monthly debts\');\n  if (parsed.liabilities.length > 0) fields.push(parsed.liabilities.length + \' liabilities\');\n  if (parsed.assets.length > 0) fields.push(parsed.assets.length + \' assets\');\n  return fields;\n}\n';

fs.writeFileSync(PARSE_URLA_DEST, parseURLA_content, 'utf8');
console.log('OK: Created src/utils/parseURLA.js');

// ── Read ScenarioCreator ──────────────────────────────────────────────────────
var src = fs.readFileSync(SCENARIO_CREATOR, 'utf8');

// ── Change 1: Add useRef ──────────────────────────────────────────────────────
src = src.replace(
  "import { useState, useEffect } from 'react';",
  "import { useState, useEffect, useRef } from 'react';"
);
console.log('OK: Added useRef to React import');

// ── Change 2: Add parseURLA import ────────────────────────────────────────────
src = src.replace(
  "import { useCRAEligibility } from '../hooks/useCRAEligibility';",
  "import { useCRAEligibility } from '../hooks/useCRAEligibility';\nimport { parseURLA, getImportSummary } from '../utils/parseURLA';"
);
console.log('OK: Added parseURLA import');

// ── Change 3: Add import state ────────────────────────────────────────────────
src = src.replace(
  "  const [loading, setLoading] = useState(false);",
  "  const [loading, setLoading] = useState(false);\n\n  // MISMO Import State\n  const [importedData, setImportedData] = useState(null);\n  const [importSummary, setImportSummary] = useState([]);\n  const [importError, setImportError] = useState('');\n  const [importFileName, setImportFileName] = useState('');\n  const mismoFileRef = useRef(null);"
);
console.log('OK: Added import state');

// ── Change 4: Add handler functions ──────────────────────────────────────────
var handlers = "  // MISMO Import Handlers\n  const handleMismoImport = (e) => {\n    const file = e.target.files?.[0];\n    if (!file) return;\n    setImportError('');\n    setImportedData(null);\n    if (!file.name.toLowerCase().endsWith('.xml')) {\n      setImportError('Please upload a valid MISMO XML file (.xml)');\n      return;\n    }\n    const reader = new FileReader();\n    reader.onload = (event) => {\n      try {\n        const parsed = parseURLA(event.target.result);\n        if (parsed.firstName)     setFirstName(parsed.firstName);\n        if (parsed.lastName)      setLastName(parsed.lastName);\n        if (parsed.loanAmount)    setLoanAmount(parsed.loanAmount);\n        if (parsed.purchasePrice || parsed.propertyValue)\n          setPropertyValue(parsed.purchasePrice || parsed.propertyValue);\n        if (parsed.interestRate)  setInterestRate(parsed.interestRate);\n        if (parsed.term)          setTerm(parsed.term);\n        if (parsed.loanPurpose)   setLoanPurpose(parsed.loanPurpose);\n        if (parsed.loanType)      setLoanType(parsed.loanType);\n        if (parsed.monthlyIncome) setMonthlyIncome(parsed.monthlyIncome);\n        if (parsed.monthlyDebts)  setMonthlyDebts(parsed.monthlyDebts);\n        if (parsed.occupancy)     setOccupancy(parsed.occupancy);\n        if (parsed.propertyType)  setPropertyType(parsed.propertyType);\n        if (parsed.streetAddress) setStreetAddress(parsed.streetAddress);\n        if (parsed.city)          setCity(parsed.city);\n        if (parsed.state)         setState(parsed.state);\n        if (parsed.zipCode)       setZipCode(parsed.zipCode);\n        const name = [parsed.firstName, parsed.lastName].filter(Boolean).join(' ');\n        const purpMap = { PURCHASE: 'Purchase', REFINANCE: 'Refi', CASH_OUT: 'Cash-Out', STREAMLINE: 'Streamline' };\n        const purpPart = purpMap[parsed.loanPurpose] || parsed.loanPurpose || '';\n        if (name) setScenarioName((name + ' - ' + parsed.loanType + ' ' + purpPart).trim());\n        setImportedData(parsed);\n        setImportFileName(file.name);\n        setImportSummary(getImportSummary(parsed));\n      } catch (err) {\n        console.error('MISMO parse error:', err);\n        setImportError(err.message || 'Failed to parse file.');\n      }\n    };\n    reader.readAsText(file);\n    e.target.value = '';\n  };\n\n  const handleClearImport = () => {\n    setImportedData(null);\n    setImportSummary([]);\n    setImportError('');\n    setImportFileName('');\n  };\n\n  const loadScenario = async () => {";

src = src.replace("  const loadScenario = async () => {", handlers);
console.log('OK: Added handler functions');

// ── Change 5: Add Import Banner JSX ──────────────────────────────────────────
var banner = "        <form onSubmit={handleSubmit} className=\"space-y-8\">\n\n          {/* MISMO Import Bar */}\n          <input ref={mismoFileRef} type=\"file\" accept=\".xml\" onChange={handleMismoImport} className=\"hidden\" />\n\n          {!importedData && !importError && (\n            <button\n              type=\"button\"\n              onClick={() => mismoFileRef.current?.click()}\n              className=\"w-full flex items-center justify-center gap-2 px-4 py-3 rounded-xl border-2 border-dashed border-blue-300 bg-blue-50 text-blue-600 text-sm font-semibold hover:bg-blue-100 hover:border-blue-400 transition-all\"\n            >\n              <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12\" />\n              </svg>\n              Import from LOS (MISMO XML) \u2014 auto-fill all fields\n            </button>\n          )}\n\n          {importError && (\n            <div className=\"flex items-start gap-3 p-4 rounded-xl bg-red-50 border border-red-300\">\n              <div className=\"flex-1\">\n                <p className=\"text-sm font-semibold text-red-700\">Import Failed</p>\n                <p className=\"text-xs text-red-500 mt-0.5\">{importError}</p>\n              </div>\n              <div className=\"flex gap-3\">\n                <button type=\"button\" onClick={() => mismoFileRef.current?.click()} className=\"text-xs text-blue-600 hover:underline\">Try Again</button>\n                <button type=\"button\" onClick={() => setImportError('')} className=\"text-xs text-gray-400 hover:text-gray-600\">\u2715</button>\n              </div>\n            </div>\n          )}\n\n          {importedData && (\n            <div className=\"rounded-xl border border-green-300 bg-green-50 overflow-hidden\">\n              <div className=\"flex items-center justify-between px-4 py-3 bg-green-100 border-b border-green-200\">\n                <div className=\"flex items-center gap-2\">\n                  <span className=\"text-sm font-bold text-green-800\">\u2705 LOS Import Successful</span>\n                  {importedData._importMeta?.losName && (\n                    <span className=\"text-xs text-green-600 bg-green-200 px-2 py-0.5 rounded-full\">{importedData._importMeta.losName}</span>\n                  )}\n                  {importedData._importMeta?.loanNumber && (\n                    <span className=\"text-xs text-gray-500\">#{importedData._importMeta.loanNumber}</span>\n                  )}\n                </div>\n                <div className=\"flex items-center gap-3\">\n                  <button type=\"button\" onClick={() => mismoFileRef.current?.click()} className=\"text-xs text-blue-600 hover:underline\">Replace File</button>\n                  <button type=\"button\" onClick={handleClearImport} className=\"text-xs text-red-500 hover:text-red-700 font-medium\">\u2715 Clear Import</button>\n                </div>\n              </div>\n              <div className=\"px-4 py-3\">\n                <p className=\"text-xs text-gray-500 mb-2\">Fields populated \u2014 all are fully editable below:</p>\n                <div className=\"flex flex-wrap gap-1.5\">\n                  {importSummary.map((field, i) => (\n                    <span key={i} className=\"text-xs bg-green-100 text-green-700 border border-green-300 px-2 py-0.5 rounded-full\">{field}</span>\n                  ))}\n                </div>\n              </div>\n              <div className=\"px-4 py-2.5 bg-amber-50 border-t border-amber-200\">\n                <p className=\"text-xs text-amber-700\">\n                  <span className=\"font-semibold\">\u26a0\ufe0f Credit score not included in MISMO files</span>\n                  {importedData.ssnPresent ? ' \u2014 SSN detected in file (not stored).' : '.'} Enter credit score manually below.\n                </p>\n              </div>\n              {importedData.liabilities?.length > 0 && (\n                <div className=\"px-4 py-3 border-t border-green-200\">\n                  <p className=\"text-xs font-semibold text-gray-600 mb-2\">Liabilities from LOS ({importedData.liabilities.length} accounts):</p>\n                  <div className=\"space-y-1 max-h-36 overflow-y-auto\">\n                    {importedData.liabilities.map((liab, i) => (\n                      <div key={i} className=\"flex items-center justify-between text-xs py-1 border-b border-green-100 last:border-0\">\n                        <div className=\"flex items-center gap-2\">\n                          <span className={'w-2 h-2 rounded-full ' + (liab.excluded ? 'bg-gray-400' : liab.payoff ? 'bg-yellow-400' : 'bg-green-500')} />\n                          <span className=\"text-gray-700 font-medium\">{liab.creditor}</span>\n                          <span className=\"text-gray-400\">({liab.type})</span>\n                        </div>\n                        <div className=\"flex gap-4\">\n                          <span className=\"text-gray-500\">${liab.balance.toLocaleString()}</span>\n                          <span className={liab.monthlyPayment === 0 ? 'text-amber-600 font-semibold' : 'text-gray-700 font-semibold'}>\n                            ${liab.monthlyPayment}/mo{liab.monthlyPayment === 0 ? ' \u26a0' : ''}\n                          </span>\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                  {importedData.liabilities.some(l => l.monthlyPayment === 0) && (\n                    <p className=\"text-xs text-amber-600 mt-1.5 font-medium\">\u26a0 $0/mo accounts may be deferred (IBR student loans). Apply 0.5-1% rule for FHA qualifying.</p>\n                  )}\n                </div>\n              )}\n              {importedData.assets?.length > 0 && (\n                <div className=\"px-4 py-3 border-t border-green-200\">\n                  <p className=\"text-xs font-semibold text-gray-600 mb-2\">Assets \u2014 Total: ${Number(importedData.totalAssets || 0).toLocaleString()}</p>\n                  <div className=\"flex flex-wrap gap-2\">\n                    {importedData.assets.map((asset, i) => (\n                      <div key={i} className=\"text-xs bg-white border border-green-200 rounded-lg px-2.5 py-1\">\n                        <span className=\"text-gray-600\">{asset.institution}</span>\n                        <span className=\"text-gray-400 mx-1\">\u00b7</span>\n                        <span className=\"text-green-600 font-semibold\">${asset.value.toLocaleString()}</span>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              )}\n              <div className=\"px-4 py-2 border-t border-green-200\">\n                <p className=\"text-xs text-gray-400\">\ud83d\udcce {importFileName}</p>\n              </div>\n            </div>\n          )}\n          {/* END MISMO Import Bar */}";

src = src.replace(
  '        <form onSubmit={handleSubmit} className="space-y-8">',
  banner
);
console.log('OK: Added import banner JSX');

// ── Verify ────────────────────────────────────────────────────────────────────
var checks = [
  ['useRef import',     src.includes('useRef')],
  ['parseURLA import',  src.includes("from '../utils/parseURLA'")],
  ['import state',      src.includes('importedData')],
  ['mismoFileRef',      src.includes('mismoFileRef')],
  ['handleMismoImport', src.includes('handleMismoImport')],
  ['handleClearImport', src.includes('handleClearImport')],
  ['Import banner',     src.includes('LOS Import Successful')],
];

var allPassed = true;
checks.forEach(function(check) {
  if (check[1]) {
    console.log('OK: ' + check[0]);
  } else {
    console.error('FAILED: ' + check[0]);
    allPassed = false;
  }
});

if (!allPassed) {
  console.error('\nSome changes failed. ScenarioCreator.jsx was NOT saved.');
  process.exit(1);
}

fs.writeFileSync(SCENARIO_CREATOR, src, 'utf8');
console.log('\nSUCCESS: All changes applied!');
console.log('FILES UPDATED:');
console.log('  src/utils/parseURLA.js        (NEW)');
console.log('  src/pages/ScenarioCreator.jsx (UPDATED)');
console.log('\nNEXT STEPS:');
console.log('  1. Ctrl+Shift+R in browser to hard refresh');
console.log('  2. Open Create New Scenario');
console.log('  3. You will see the Import from LOS button at the top');
console.log('  4. git add . && git commit -m "feat: MISMO XML import for ScenarioCreator"');
